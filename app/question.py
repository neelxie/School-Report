embedded_json = []

Agnes = [{"Category":"Animal","Subcategory":"Pigs","Question_id":11853,"Language":"English","Location of farmer":"Seeta","Question":"Why is my pig having red wounds on the ears","Answer":"This is usually caused by bitting flies"},{"Category":"Animal","Subcategory":"Pigs","Question_id":11872,"Language":"English","Location of farmer":"Kiryandongo","Question":"What are the best feeds for piggery","Answer":"concentrates of a combination of feed ingredients like soya , maize ,maize bran and other concentrates"},{"Category":"Animal","Subcategory":"Pigs","Question_id":11890,"Language":"English","Location of farmer":"Madi Okollo District","Question":"I am a piggery farmer, I have my 5 months old piglets of which they have been diarrating(diarrhoea),lost appetite and weak too.What could be the disease and how can it be prevented so that other can not have such a similar problems","Answer":"It could be an infection due to poor hygiene conditions. this can be contained by administering anti biotics for example alamycine"},{"Category":"Animal","Subcategory":"Pigs","Question_id":11894,"Language":"English","Location of farmer":"Dokolo","Question":"What is biosecurity in piggery","Answer":"These are measure put  in place to safe guard against disease entry into  pig units"},{"Category":"Animal","Subcategory":"Pigs","Question_id":11917,"Language":"English","Location of farmer":"Kiryandongo","Question":"What are the best way to control parasite in piggery","Answer":"By maintaining high level of hygiene through regular cleaning of units and periodic disinfection."},{"Category":"Animal","Subcategory":"Pigs","Question_id":11918,"Language":"English","Location of farmer":"Kiryandongo","Question":"Whats the best way of castrating pigs","Answer":"Pigs can only be castrated by open surgery"},{"Category":"Animal","Subcategory":"Pigs","Question_id":11970,"Language":"English","Location of farmer":"Kiryandongo","Question":"What causes swine fever in piggery ","Answer":"Swine fever is caused by a virus through contact with infected sources "},{"Category":"Animal","Subcategory":"Pigs","Question_id":11971,"Language":"English","Location of farmer":"Kiryandongo","Question":"What are the control measures of swine in piggery?","Answer":"Control measures include;strict emphasis on piggery units entry points by carrying out disinfection of  personnel and machinery equipments"},{"Category":"Animal","Subcategory":"Pigs","Question_id":11972,"Language":"English","Location of farmer":"Kiryandongo","Question":"How many times are pigs supposed eat in a day?","Answer":"Pigs can be fed twice a day that is morning and evening"},{"Category":"Animal","Subcategory":"Pigs","Question_id":11973,"Language":"English","Location of farmer":"Kiryandongo","Question":"What is the gestation period of pigs","Answer":"It is 3 months,3 weeks and 3 days "},{"Category":"Animal","Subcategory":"Pigs","Question_id":11989,"Language":"English","Location of farmer":"Ngora, Uganda","Question":"Why is it important to house pigs?","Answer":"Pigs react to extremes of temperatures and environmental conditions, therefore they need to be protected so that they can perform better"},{"Category":"Animal","Subcategory":"Pigs","Question_id":11990,"Language":"English","Location of farmer":"Ngora","Question":"What are the possible ways of preventing swine fever in pigs?","Answer":"by putting up bio security measures, by not feeding them on left overs from restaurants, by fencing to avoid direct contact with wild animals "},{"Category":"Animal","Subcategory":"Pigs","Question_id":12015,"Language":"English","Location of farmer":"Madi Okollo District","Question":"My sow furrowed 11piglets, the following morning found four piglets dead, what could have gone wrong?","Answer":" These pigglets might have died due to crashing."},{"Category":"Animal","Subcategory":"Pigs","Question_id":12018,"Language":"English","Location of farmer":"Madi Okollo District","Question":"Which breed of pig is good in West Nile?","Answer":"I would recommend cross breeds between large white and land race for easy adaptability to environmental conditions"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12029,"Language":"English","Location of farmer":"Kiryandongo","Question":"What can be done to increase on the number of piglets in sows","Answer":" you can improve on the nutrition, improve on the genetics through cross breeding, carryout continous selection. proper timing of the heat cycle"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12030,"Language":"English","Location of farmer":"Kiryandongo","Question":"What is the gestation period of sows","Answer":"It is 3 months,3 weeks and 3 days "},{"Category":"Animal","Subcategory":"Pigs","Question_id":12031,"Language":"English","Location of farmer":"Isingiro","Question":"What is the best breed in pigs?","Answer":" cambroughis the best pig breed since it has a fast growth rate compared to other breeds, low fat ratio to meat and produces a good number of piglets."},{"Category":"Animal","Subcategory":"Pigs","Question_id":12032,"Language":"English","Location of farmer":"Isingiro","Question":"what is the common disease in pigs?","Answer":"African swine fever is the most common disease in pigs"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12033,"Language":"English","Location of farmer":"Isingiro","Question":"what is the common breeding method in pigs?","Answer":"Natural mating the most common breeding method "},{"Category":"Animal","Subcategory":"Pigs","Question_id":12034,"Language":"English","Location of farmer":"Isingiro","Question":"what factors do i consider before starting a piggery project?","Answer":"Let us consider land , labour and enterprenship "},{"Category":"Animal","Subcategory":"Pigs","Question_id":12035,"Language":"English","Location of farmer":"Isingiro","Question":"what are the ways of improving pig meat?.","Answer":"by carrying out breed selection and improving the diet "},{"Category":"Animal","Subcategory":"Pigs","Question_id":12036,"Language":"English","Location of farmer":"Isingiro","Question":"what are the management practices under piggery?.","Answer":"Breeding and selection, feeding, housing and veterinary care"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12037,"Language":"English","Location of farmer":"Isingiro","Question":"what is the best way of feeding piglets?.","Answer":"Feed the piglets  on creep feed"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12038,"Language":"English","Location of farmer":"Isingiro","Question":"how do i rise a one day piglet?.","Answer":"The best way is by breast feeding from the mother  to get colostrum"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12039,"Language":"English","Location of farmer":"Isingiro","Question":"how do i cater for the pregnant pig?","Answer":"It should be well housed, given proper nutrition, both quantity and qualility , proper veterinary care"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12040,"Language":"English","Location of farmer":"Isingiro","Question":"What is the common disease in pigs?","Answer":"The common disease in pigs is African Swine fever"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12041,"Language":"English","Location of farmer":"Isingiro","Question":"What is the common breeding method in pigs?","Answer":"natural mating the most common breeding method "},{"Category":"Animal","Subcategory":"Pigs","Question_id":12042,"Language":"English","Location of farmer":"Isingiro","Question":"What are the ways of improving pig meat?","Answer":"genetically through breed improvement,feeding"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12043,"Language":"English","Location of farmer":"Isingiro","Question":"What are the management practices under piggery?","Answer":"Breeding and selection, feeding, housing and veterinary care"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12044,"Language":"English","Location of farmer":"Isingiro","Question":"What is the best way of feeding piglets?","Answer":"by feeding them on creep feed"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12045,"Language":"English","Location of farmer":"Isingiro","Question":"How do I rise a one day piglet?","Answer":"by feeding them on colostrum"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12047,"Language":"English","Location of farmer":"Isingiro","Question":"What feed  ingredients do I mix to make pigs feeds?","Answer":"soya bean meal,cotton seed cake, fish meal, maize bran, whole maize"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12052,"Language":"English","Location of farmer":"Kyotera","Question":"What is artificial insemination as used in animal husbandry?","Answer":"this is the a special mating in animals using artifical means"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12053,"Language":"English","Location of farmer":"Kyoteta","Question":"Explain the merits and demerits of artificial insemination.","Answer":"merits include; it reduces on the cost of taking care of a male,its accurate, reduces on disease spread,reduces chances of injury. demerits include; its expensive to carryout and  requires skilled labour,"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12055,"Language":"English","Location of farmer":"Kyotera","Question":"List down ten(10)breeds of pigs reared in Uganda for commercial.","Answer":"landrace, large white, saddle back, camborough, duroc, hampshire, large black, pietraine, guinea pigs,"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12056,"Language":"English","Location of farmer":"Kyotera","Question":"State the factors to consider when selecting a good breed of animal.","Answer":"number of teats should be atleast 12 -14,  it should be selected from mothers with a litter size of 8-10 piglets"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12057,"Language":"English","Location of farmer":"Kyotera","Question":"Explain record keeping and its advantages in animal management.","Answer":"is the storing and obtaining of facts of the farm for further use. advantages include; it enables farmers to know whether they are making profits or losses,its used to track individual animal performance in growth and production, it enables farmers to make informed decisions about their farms"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12091,"Language":"English","Location of farmer":"Moroto District","Question":"What is the best piggery breed for rearing?","Answer":"the best pig breed is camborough "},{"Category":"Animal","Subcategory":"Pigs","Question_id":12093,"Language":"English","Location of farmer":"Kiryandongo","Question":"How do I get to make low cost feeds of pigs?","Answer":"This can be achieved by acquiring knoweldge from experts in feed mixing which can  be used to make farm mixed feeds, by growing some of the ingredients like soya, maize  to reduce on the costs"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12094,"Language":"English","Location of farmer":"Kiryandongo","Question":"Whats the difference between Hampshire and large white breed of pigs","Answer":" Large  white breed has a dished face while hampshire has a strip on one side of the leg, the number of piglets produced by large white are more than those of hampshire"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12095,"Language":"English","Location of farmer":"Kiryandongo","Question":"How can I increase on the number female piglets my piggery farm","Answer":"By use of sexed semen which can be used to inserminate a sow to get piglets of the same sex though its not a common practice in uganda."},{"Category":"Animal","Subcategory":"Pigs","Question_id":12100,"Language":"English","Location of farmer":"Kampala","Question":"How can I know that my pig is on heat","Answer":"Loss of appetite, reddening and enlargement of the vulva, flequent urination"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12102,"Language":"English","Location of farmer":"Kampala","Question":"What type of pig breed can I keep for better returns","Answer":"camborough is the best pig breed since it has less fat, high growth rate and  proper utilisation of feeds consumed compared to other breeds of pigs"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12172,"Language":"English","Location of farmer":"Moroto District","Question":"Name essential features of a piggery unit","Answer":" should be well drained, should have a leak proof roof and a well constructed wall that can protect the pigs from extremes of temperatures"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12178,"Language":"English","Location of farmer":"Gudi Leisure Farm, Najjera","Question":"What is a piggery farm?","Answer":"this is a place where pigs are raised or kept"},{"Category":"Animal","Subcategory":"Pigs","Question_id":12179,"Language":"English","Location of farmer":"Gudi Leisure Farm, Najjera","Question":"How do I start a piggery farm?","Answer":"to start a piggery farm, one needs land, labour and entreprenuership"}]
RobertIsabirye = [{"Category":"Animal","Subcategory":"Chicken","Question_id":11282,"Language":"English","Location of farmer":"Moroto","Question":"What are the main causes of the rapid spread of coccidiosis in poultry rearing?","Answer":"The main causes of the rapid spread of coccidiosis in through ingestion of contaminated faeces from sick birds. To avoid the spread of coccidiosis therefore, the farmer should practise strict hygiene. Utensils should be cleaned thoroughly before feed and water free from disease is added. There is a vaccine for protection but it is not readily available on the Ugandan market. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11317,"Language":"English","Location of farmer":"Wakiso","Question":"What could be the cause of cough in chicks of 1 week","Answer":"Cough in chicks of 1 week can be caused by a number of factors: - Diseases for example mycoplasma gallisepticum; infectious bronchitis; OR chronic respiratory disease (CRD). Stress can be a predisposing factor for underlying diease to show up. Birds suffering with respiratory disease should always be isolated from healthy stock to limit spread of the disease since respiratory diseases are usually very contagious in nature. the consult the area vet for a solution."},{"Category":"Animal","Subcategory":"Chicken","Question_id":11318,"Language":"English","Location of farmer":"Wakiso","Question":"What is the cause of birds dehorning?","Answer":"Dehorning in birds is not practical. It is only prectised in mammals for example in cattle and goats. It is carried out to avoid injury to the animal and others on the farm, a dehorned animal is easier  to transport, and a dehorned animal takes less space during thransportation. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11319,"Language":"English","Location of farmer":"Wakiso","Question":"What causes vent prolapse in layers","Answer":"Vent prolapse can be due to: - Large eggs which are oversized; obesity of the layer; double yolked egss; nutritional deficiency especially when the diet lacks minerals especially calcium, magnesium and other minerals; infection for example egg peritonitis which is a fatal infection inside the abdomen."},{"Category":"Animal","Subcategory":"Chicken","Question_id":11320,"Language":"English","Location of farmer":"Kampala, Uganda","Question":"What could be the reason for birds with laying age failing to lay eggs","Answer":"The reasons for birds of laying age failing to lay eggs are: Stress especially emotional stress due to e.g. transposportation; water deprivation; nutritional deficiency as a result of not getting sufficient nutrients in feed; inadequate light in the poultry unit leading to reduction in day length (14 hours of light per day are commended); moulting whereby hens divert protein and energy away from egg production to concentrate on feather growth. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11321,"Language":"English","Location of farmer":"Kampala, Uganda","Question":"How can I avoid egg damage on my poultry farm","Answer":"Egg damage on a poultry farm can be avoided by: avoid overcrowding of the hens, do not disrupt the birds which might result into egg breakages, keep the farm free from disease since some diseases reduce the quality of eggshell. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11322,"Language":"English","Location of farmer":"Mitooma Uganda","Question":"What causes blindness in birds and what treatment can I give to my birds","Answer":"Blindness in birds can be due to: Bacterial infections e.g. salmonella; Fungal infections usually acquired through eating mouldy feed; vitamin A deficiency or inury in one or both eyes. Blindness can be treated by: flushing sterile saline solution, but it is better to consult the vet for  timely and appropriate treatment."},{"Category":"Animal","Subcategory":"Chicken","Question_id":11323,"Language":"English","Location of farmer":"Kampala, Uganda","Question":"What are the effects of ammonia gas in the poultry house","Answer":"The effects of ammonia gas in a poultry house are: gasping, sneezing, nasal discharge, coughing. Ammonia also corrodes  the respiratory tract leading to bacteria infections. This predisposes the birds to many other diseases and also causes severe stress. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11324,"Language":"English","Location of farmer":"Kampala, Uganda","Question":"How many layers should be in one meter squared at laying age","Answer":"There should be 4 to 6 layers of laying age per square metrer. Therefore on average they should be 5 layers per square metre. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11325,"Language":"English","Location of farmer":"Hoima Uganda","Question":"Loss of feathers in breeders birds what causes it","Answer":"Loss of feathers in breeder birds is caused by: Poor diet especially when there is no enough protein, vitamins or minerals inthe diet; parasitism especially mites and lice infestation; during broodness especially if the hen can use its body temperature to keep the eggs at the appropriate body temperature for hatching if the hens are bred for sitting on the eggs by themselves and not by placing the an artificial incubator."},{"Category":"Animal","Subcategory":"Chicken","Question_id":11326,"Language":"English","Location of farmer":"Kampala, Uganda","Question":"What causes the death of birds immediately after debeaking","Answer":"Death of birds immediately after debeaking may be due to too much loss of blood (bleeding) and pain to the birds. Only when carried out badly,then  debeaking can cause death, otherwise it is very rare for death to result from debeaking. It is advisable to employ an experienced person to carry out debeaking. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11327,"Language":"English","Location of farmer":"Kampala, Uganda","Question":"How long does the Cobb 500 broiler breed take to lay","Answer":"The Cobb 500 broiler lays at the age of 26 weeks. Since it was breed as a broiler and not a layer breed, it takes longer that layer breeds to lay eggs. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11328,"Language":"English","Location of farmer":"Kampala, Uganda","Question":"What are the challenges of too much heat in brooding","Answer":"Too much heat in brooding can lead to the following challenges: Dehdration which comes as a result of too much loss of water from the body and due to excessive panting; poor growth; loss of appetite; and increase in mortality.  "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11329,"Language":"English","Location of farmer":"Kampala, Uganda","Question":"What causes litter wetness in poultry house","Answer":"Wetness of litter in poultry house may be caused by: diarrhoeal diseases; poor diet and nutrition; and failure to control spilling of water into the litter. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11331,"Language":"English","Location of farmer":"Kampala, Uganda","Question":"What are the types of layer birds we have in Uganda","Answer":"The types of layer birds (chicken) we have in Uganda are: Lehman brown, Gold brown, Harvard white and ISA brown. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11332,"Language":"English","Location of farmer":"Kampala, Uganda","Question":"How best can I transport my birds from the farm to the market without stressing them","Answer":"The best way to transport birds from the farm to the market without stressing them is by placing them in cages or plastic containers. These should be having enough holes on them to allow ventilation. It is also advisable not to crowd birds in one container, othewise they can suffocate and cause deaths to the birds. "},{"Category":"Animal","Subcategory":"Ducks","Question_id":11333,"Language":"English","Location of farmer":"Kampala Uganda","Question":"What causes Newcastle diseases in poultry","Answer":"Newcastle disease in poultry is caused by virulent strains of avian paramyxovirus type 1"},{"Category":"Animal","Subcategory":"Chicken","Question_id":11334,"Language":"English","Location of farmer":"Kampala, Uganda","Question":"What is the recommended brooding temperature in chicken","Answer":"Recommended brooding temperature is set depending on the age of the chicks. As the birds start developing feathers, the temperature is lowered a bit as follows: 0 - 1 week = 33.9 - 35 \u00b0C; week 1 - 2 = 31.1 - 32.2\u00b0C; Week 2 - 3 = 28.3\u00b0 to 29.4\u00b0C."},{"Category":"Animal","Subcategory":"Chicken","Question_id":11336,"Language":"English","Location of farmer":"Kampala, Uganda","Question":"How long should poultry manure take before use in plantations","Answer":"Poultry manure should take a minimum of 3 months before it can be taken to the plantation. It is avdisable however, if possible to wait for 6 months to 1 year. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11337,"Language":"English","Location of farmer":"Kampala, Uganda","Question":"How can we differentiate between female chicks at day one old","Answer":"Female and male chicks at day one old can be differentiated using the feather sexing method as follows: The wing feathers will seem longer or vary in size if the bird is a female; and the male chicks the wing feathers are almost the same lengths. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11338,"Language":"English","Location of farmer":"Kampala Uganda","Question":"What causes vent pecking in poultry","Answer":"Vent pecking is caused by: Too much light in the laying nests; and at times due to boredom; and due to frequent changing of diet of the birds. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11339,"Language":"English","Location of farmer":"Kampala Uganda","Question":"What causes prolapse in chicken broilers","Answer":"Prolpse in broilers is caused by: Calcium deficiency; or holding droppings for too long period causing stress and stretching the cloaca."},{"Category":"Animal","Subcategory":"Chicken","Question_id":11340,"Language":"English","Location of farmer":"Kampala Uganda","Question":"How does age affect the performance of the animal chicken","Answer":"Age affects the performance of chicken in that as the chicken grows it reaches a time when its meat starts becoming very tough "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11345,"Language":"English","Location of farmer":"Kampala, Uganda","Question":"How best can I utilize the wastes like blood, and offals after slaughtering chicken if I dont want to give as per feeds?","Answer":"Wastes like blood and offals after slaughtering chicken if not used to give as per feed can be utilized as follows: They can be used in a biodigester to generate biogas and te slurry generated is used in gardens as organic fertilizer to improve on fertility of te soil. In so doing the biogas is used as a renewable source of energy in cooking, lighting and other uses. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11346,"Language":"English","Location of farmer":"Kampala, Uganda","Question":"What is the recommended weight that should be the desired minimum before slaughtering chicken for marketing?","Answer":"The recommended desired weight before slaughter is 1300 gms.  "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11348,"Language":"English","Location of farmer":"Kampala, Uganda","Question":"How best can poultry farmer can minimise on feed costs to feed his chicken in layers farm apart from providing greenish pastures.","Answer":"Apart from providing greenins pastures, Poultry farmer can minimize on feed costs to feed his layer chicken farm   by doing the following: Keeping efficient breeds i feed utilization; mixing whole grain with chicken feed; fermenting the chicken feed, this will provide all bacteria that are good for the gut hence efficient feed utilization; growing on your own some of the feed ingredients; and avoiding overfeeding the flock.  "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11349,"Language":"English","Location of farmer":"Kampala Uganda","Question":"What causes shells eggs in layers","Answer":"Most of the problems associated to shells in layers are attributed to deficiency of minerals especially calcium. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11361,"Language":"English","Location of farmer":"Ngora","Question":"How can pneumonia be controlled by farmers","Answer":"Pneumonia in poultry can be controlled by farmers by: ensuring proper housing with good ventilation and avoiding dampness in the housing units; and .thoroughly cleaning feed and water utensils regularly to avoid cross contamination of feed or bedding supplies. Also, frequently relocate feeders and water dispensers to discourage mould growth. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11386,"Language":"English","Location of farmer":"Ngora, Uganda","Question":"What are the reasons for egg breaking and drinking layers in a deep litter-rearing system?","Answer":"The reasons for birds of laying age failing to lay eggs are: Stress especially emotional stress due to e.g. transposportation; water deprivation; nutritional deficiency as a result of not getting sufficient nutrients in feed; inadequate light in the poultry unit leading to reduction in day length (14 hours of light per day are commended); moulting whereby hens divert protein and energy away from egg production to concentrate on feather growth. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11387,"Language":"English","Location of farmer":"Ngora, Uganda","Question":"What preparations should be carried out before the arrival of one-day-old chicks?","Answer":"The following preparations should be carried out before the arrival of one day old chicks: The brooder should be cleaned and all unnecessary items removed; the brooder disinfected at least 14 days before expected arrival of the chicks; start heating the brooder for 24 to 36 hours depending on the outside temperatures. Then on the day of arrival, arrange all the utensils especially the drinkers and feeder and make sure all the lighting and heating devices are all functioning very well. Ensre that there is water soluble glucose to give the chicks on arrival."},{"Category":"Animal","Subcategory":"Chicken","Question_id":11388,"Language":"English","Location of farmer":"Ngora","Question":"What behavioral activities indicate that the chicks are under stress","Answer":"The  behavioural activities that indicate that the birds are under stress are: They are aggressive, feather pecking; peeping loudly and consistently; reduced activity and at times lack of appetite."},{"Category":"Animal","Subcategory":"Chicken","Question_id":11389,"Language":"English","Location of farmer":"Ngora","Question":"How can a farmer manage stress in young chicks","Answer":"A farmer can manage stress in young chicks by: Giving clean fresh water all the time; keeping all utensils clean regularly; Give good nutritive diet; ensure there is enough ventilation in the poultry house; keep away animals e.g. dogs far away from the poultry house; handle the chicks with care as much as possible."},{"Category":"Animal","Subcategory":"Chicken","Question_id":11420,"Language":"English","Location of farmer":"Mbarara","Question":"What causes egg pecking in chickens when using feed concentrates?","Answer":"Egg pecking in chickens when using feed concentrates is caused by:  Insufficient calcium in the diet or weak shells which are as a result os inadequate calcium in the diet; "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11421,"Language":"English","Location of farmer":"Mbarara","Question":"What causes chickens to peck each others behind?","Answer":"Causes of vent pecking in chickens are: Sodium deficiency inthe diet; very bright light in the laying area;  stress to the birds; inadequate nutrients in the diet; overheating; when the feeders and drinkers are left empty; and poor ventiation leading to inadequate aeration in the poultry house. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11422,"Language":"English","Location of farmer":"Mbarara","Question":"Is it recommended to mix large volumes of chicken feed and store it, if yes what is the preferred storage time?","Answer":"No it is not advisable to mix large volumes of chicken feed and store it especially if it will take long for all of it to be consumed. This is because during storage the feed will deteriorate and lose its quality is kept for more that 2 months. This will lead to development of moulds; poor growth of the birds; malnutrition; and health complications. Feeds should not be stored for more than 2 months once mixed. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11423,"Language":"English","Location of farmer":"Mbarara","Question":"Is it advisable to switch off the lights at night so that broiler chickens could rest?","Answer":"Switch off for only 4 hours per day, do not switch off lights completely the whole night.This will lead to best performance in terms of body weight gain. The 4 hours are enough for the broilers to rest."},{"Category":"Animal","Subcategory":"Chicken","Question_id":11424,"Language":"English","Location of farmer":"Mbarara","Question":"Comparing the cost of feeds, concentrate, and the normal ingredients what could be the best ingredients for fast growth when mixing chicken feed?","Answer":"Comparing the cost of feeds, concentrate, and the normal ingredients the best ingredients for fast growth when mixing chicken feed could be : It is advisable to embrace homemade feeds which must include concentrates and locally available ingredients for example broken maize; maize brans; and soy meal. Ensure that the formula (ratio) used in mixing the various ingredients and quantity of concentrates used is the one recommended by the manufacturer of the concentrate for best results."},{"Category":"Animal","Subcategory":"Chicken","Question_id":11425,"Language":"English","Location of farmer":"Mbarara","Question":"What causes rickets in chickens?","Answer":"Rickets is caused  either by deficiency of vitamin D3, or calcium, or phosphorus or calcium - phosphorus imbalance in the body"},{"Category":"Animal","Subcategory":"Chicken","Question_id":11426,"Language":"English","Location of farmer":"Mbarara","Question":"Which is the best breed for broiler rearing?","Answer":"Cobb 500 is the best broiler worldwide due to its meat quality and performance in terms of feed conversion efficiency. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11435,"Language":"English","Location of farmer":"Mbarara","Question":"What causes swelling of eyes in chicks?","Answer":"Swelling of eyes in chicks is usually caused by infectious coryza (fowl coryza). it is a bacterial disease."},{"Category":"Animal","Subcategory":"Turkeys","Question_id":11439,"Language":"English","Location of farmer":"Mbarara","Question":"What causes soars on beaks of turkeys?","Answer":"Soars on beaks of turkeys are caused by a viral disease called avaian pox. tHe soars are as a result of lesions and some kind of nodules which rapture leaving behind soars. This disease is controlled by vaccination. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11702,"Language":"English","Location of farmer":"Butambala","Question":"How can I use black flies larva for chicken feed?","Answer":"Black soldier fly larvae are used to feed chicken in the following ways: The live larvae can be scattered on chicken feed and the chicken will enjoy pecking them. Secondly, the larvae can be processed into powder and mixed together with other feed ingredients in recommended  proportions. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11658,"Language":"English","Location of farmer":"Mbarara","Question":"What causes soars on beaks of turkeys?","Answer":"Soars on beaks of turkeys are caused by a viral disease called avaian pox. tHe soars are as a result of lesions and some kind of nodules which rapture leaving behind soars. This disease is controlled by vaccination. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11659,"Language":"English","Location of farmer":"Mbarara","Question":"Whats the estimated feed consumption of a broiler chicken till six week of selling off ?","Answer":"The estimated feed consumption of a broiler chicken till six weeks of selling off is 2.5 kg (2500 gms)"},{"Category":"Animal","Subcategory":"Chicken","Question_id":11660,"Language":"English","Location of farmer":"Mbarara","Question":"Coffee and rice husks, which is the best bedding in chicken right from brooding ?","Answer":"Coffeee husks are better to use in chicken right from brooding as compared to rice husks. This is because the rice husks form lamps (caking) making it hard to maintain good litter in te poultry house in deep litter suystem. Coffee husks even when exposed to some little moisture dry easily and rarely form lamps. Additionally, when used in the brooder when the birds are still very youing, rice husks can easily be mistaken for feed by the chicks since feed and rice husks look very similarand this can choke the chicks. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11662,"Language":"English","Location of farmer":"Mbarara","Question":"For how long should the covering of husks in brooder be maintained before being exposed to the chicks?","Answer":"The covering of husks in brooder be maintained for 1 to 2 days before being exposed to the chicks. Covering is not necessary beyong this period because the birds can differentiate between feeds to husks.  "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11663,"Language":"English","Location of farmer":"Mbarara","Question":"For the case of food safety, how best could chicken carcass be transported for consumption?","Answer":"For the case of food safety, chicken carcasses sould be transported in refrigerated containers or in frozen form to inhibit spoilage and growth of pathogens.  "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11665,"Language":"English","Location of farmer":"Mbarara","Question":"What is the significance of record keeping at the farm?","Answer":"Significance of record keeping at a farm is as outlined below: Know financial status at a point of time; can help farmers obtain a bank loan; Measure efficiency and progress; Easier to prepare accounts at year end; Avoid over\/under tax payments. Identify strengths and weaknesses in the farm business. Help manage changes and improvements in the agribusiness; Enable to Make productivity projections\n"},{"Category":"Animal","Subcategory":"Chicken","Question_id":11666,"Language":"English","Location of farmer":"Kampala","Question":"What are the key factors to consider when starting a poultry keeping project?","Answer":"Location: The place must be conducive when it comes to marketing products, there should be a ready market nearby; The budget: There should be enough money to run the projectecd business; The sector to be involved in must be clear, for egg production, or for meat production; Road to access the market should available; there must be a reliable source of water for cleaning utensils, for drinking by the birds; Source of feeds should be available"},{"Category":"Animal","Subcategory":"Chicken","Question_id":11683,"Language":"English","Location of farmer":"Mbarara","Question":"At what stage is debeaking recommended?","Answer":"In Uganda debeaking is recommended at the age of 6 to 8 weeks if a local debeaking knife is used. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11684,"Language":"English","Location of farmer":"Mbarara","Question":"What causes the falling of feathers in layers chicken?","Answer":"Falling of feathers (moulting) in layer chicken is caused by mainly stress especially due to water and feed deprivation; too much heat or illness. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11685,"Language":"English","Location of farmer":"Mbarara","Question":"What causes egg pecking yet being fed on concentrates?","Answer":"Egg pecking yet the birds  are fed on concentrates is caused by calcium or vitamin D deficiency or by the bords developing the vice due to curiousity after seeing a broken egg and the vice continues. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11686,"Language":"English","Location of farmer":"Mbarara","Question":"What causes swelling and soars in between chicken feet?","Answer":"Swelling and sores in between chicken feet (bumblefoot or pododermatitis) is caused by is a bacterial infection that affects chickens\u2019 feet, typically caused by an injury that becomes contaminated with bacteria such as Staphylococcus aureus, E-coli, and Pseudomona. This leads to swelling, soreness and limping inthe affected chicken "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11687,"Language":"English","Location of farmer":"Mbarara","Question":"During brooding, what causes the spreading of wings by chicks?","Answer":"The spreading of wings by chicks during brooding is caused by too much heat in the brooder. Threfore the chicks spread their wings so as to cool down."},{"Category":"Animal","Subcategory":"Chicken","Question_id":11688,"Language":"English","Location of farmer":"Mbarara","Question":"Is it recommended to keep reducing the amount of concentrate in the chicken feed as they grow?","Answer":"Yes. Concentrates contain a substantial amount of vitamin A and vitamin E, also lysine and methionine. Vitamins are needed in reducing amounts as the birds grow from starter to grower and to finisher stages in broiler chicken. Instead crude fibre, oil and fat and metabolisable energy is needed in increasing quantities as the birds grow. Therefore the amount of concentrate should be reduced but in reference to the formula being used by the farmer. This should not however, be done haphazardly. "},{"Category":"Animal","Subcategory":"Chicken","Question_id":11689,"Language":"English","Location of farmer":"Mbarara","Question":"What is the recommended height for ventilation in broiler and layer chicken?","Answer":"To protect the birds from rain or cold climate and to ensure enough ventilation, the height for ventilation in broiler and layer houses should be 1 \u2013 1.5 feet from the floor. "},{"Category":"Animal","Subcategory":"Ducks","Question_id":11721,"Language":"English","Location of farmer":"Kampala","Question":"What are the ideal housing requirements for ducks","Answer":"The ideal housing requirements for ducks are: The house must be well-ventilated; should be easy to clean because ducks defecate a lot; there should be a nest in one corner of the house; should be good enough to shelter the ducks from extreme weather and from predators; there should be 16 square feet of outdoor roaming area and 5 square feet of floor space for each duck. "},{"Category":"Animal","Subcategory":"Ducks","Question_id":11723,"Language":"English","Location of farmer":"Kampala","Question":"How do I maintain good health in my duck flock","Answer":"To maintain good health in a duck flock the following is required: Provide a nutritionally complete and balanced diet formulated specifically for waterfowl; pre[are water areas for them to swim especially during the hot season; provide ample space and do not crowd them; provide clean comfortable environment; provide beddings and change them frequently to ensure a healthy and clean habitat."},{"Category":"Animal","Subcategory":"Ducks","Question_id":11725,"Language":"English","Location of farmer":"Kampala","Question":"How do I optimize egg production in duck farming","Answer":"To maximumize egg production in ducks the following should be done: Give the ducks 14 hours of light once they have reached sexual maturity; provide good quality feed and in sufficient quantities of 170 to 200 gms per duck per day, do not give too much feed; provide good quality water and avoid exposing them to any form of stress; and Ensure proper housing"},{"Category":"Animal","Subcategory":"Ducks","Question_id":11729,"Language":"English","Location of farmer":"Kampala","Question":"How do I integrate ducks into integrated farming systems for pest control","Answer":"Ducks can be integrated into an integrated farming system for pest control by: Incorporating organic duck farming with organic fish farming and organic rice farming to create a sustainable eco-friendly farming system. This integrated system provides several benefits, including zero use of synthetic pesticides and fertilizers, natural pest control, and natural fertilizer production.organic duck farming promotes a healthier environment, minimizes animal suffering, and encourages responsible stewardship of resources.\n\n"}]
list_of_expertiz = {
	'Agnes': {'id': 180}, 'RobertIsabirye': {'id': 197},
}

derek_list = {'Agnes': Agnes, 'RobertIsabirye': RobertIsabirye
}

import json

from app.status import (
	HTTP_200_OK,
	HTTP_201_CREATED,
	HTTP_204_NO_CONTENT,
	HTTP_400_BAD_REQUEST,
	HTTP_404_NOT_FOUND,
	HTTP_409_CONFLICT,
)
from flask import Blueprint, request, send_file
from flask.json import jsonify
import pandas as pd
from flask_jwt_extended import get_jwt_identity, jwt_required, verify_jwt_in_request
from app.models import Question, db, User, Answer
import datetime
import random
import os
from os.path import join, dirname, realpath
from io import StringIO
from google.cloud import storage

from sqlalchemy import func, or_, and_, not_, text
from app.helper import admin_required

UPLOADS_PATH = join(dirname(realpath(__file__)), "static/audio_uploads")
DATASET_PATH = join(dirname(realpath(__file__)), "static/dataset")

questions = Blueprint("questions", __name__, url_prefix="/api/v1/questions")

def get_audio_file_content(file_path):
	# file_path = os.path.join(UPLOADS_PATH, filename)
	return send_file(file_path, as_attachment=True)



def format_question(question, language):
	return {
		"id": question.id,
		"sentence": question.sentence,
		"language": question.language,
		"created_at": question.created_at.strftime("%Y-%m-%d %H:%M:%S"),
		"topics": question.topic,
		"sub_topic": question.sub_topic,
		"category": question.category,
		"animal_crop": question.animal_crop,
		"location": question.location,
		"question_language": language,
		"filename": question.filename,
	}

def jsonify_question(question):
	return {
		"id": question.id,
		"sentence": question.sentence,
		"language": question.language,
		"created_at": question.created_at.strftime("%Y-%m-%d %H:%M:%S"),
		"topics": question.topic,
		"sub_topic": question.sub_topic,
		"category": question.category,
		"animal_crop": question.animal_crop,
		"location": question.location,
		"filename": question.filename,
		"reviewed": question.reviewed,
		"answered": question.answered
	}

def file_name(file):
	name = file.filename
	file_name, file_extension = os.path.splitext(name)
	return file_name, file_extension

def chanelle(value):
	if int(value) == 6:
		return 5
	try:
		return int(value)
	except ValueError:
		return 1

@questions.route("/", methods=["POST", "GET"])
@jwt_required()
def handle_questions():
	def process_single_question(question_data, current_user):
		sentence = question_data.get("sentence", "")
		language = question_data.get("language", "")
		topic = question_data.get("topic", "")
		sub_topic = question_data.get("sub_topics", "")
		category = question_data.get("category", "")
		animal_crop = question_data.get("sub_category", "")
		location = question_data.get("location", "")
		today = datetime.date.today()

		if language not in ["English", "Luganda", "Runyankole"]:
			return (
				jsonify({"error": "Invalid language selection"}),
				HTTP_400_BAD_REQUEST,
			)

		if not sentence or not language:
			return (
				jsonify(
					{
						"error": "Both sentence and language must be provided for each question"
					}
				),
				HTTP_400_BAD_REQUEST,
			)

		elif Question.query.filter_by(sentence=sentence).first():
			return (
				jsonify({"error": "This question already exists"}),
				HTTP_409_CONFLICT,
			)
		else:
			question = Question(
				sentence=sentence,
				language=language,
				user_id=current_user,
				topic=topic,
				category=category,
				animal_crop=animal_crop,
				location=location,
				sub_topic=sub_topic,
			)
			db.session.add(question)
			db.session.flush()

			num_questions = Question.query.filter_by(user_id=current_user).count()
			today = datetime.date.today()
			questions = (
				Question.query.filter_by(user_id=current_user)
				.filter(func.date(Question.created_at) == today)
				.all()
			)
			todaysQuestions = []
			for question in questions:
				todaysQuestions.append(
					{
						"id": question.id,
						"sentence": question.sentence,
						"language": question.language,
						"created_at": question.created_at,
						"topics": question.topic,
						"sub_topic": question.sub_topic,
						"category": question.category,
						"animal_crop": question.animal_crop,
						"location": question.location,
					}
				)

			return {
				"num_questions": num_questions,
				"questions": todaysQuestions,
			}, HTTP_201_CREATED

	current_user = get_jwt_identity()

	if request.method == "POST":
		data = request.get_json()

		if not data:
			return (
				jsonify({"error": "Invalid or empty JSON data provided"}),
				HTTP_400_BAD_REQUEST,
			)

		if isinstance(data, list): 
			results = []
			for question_data in data:
				result = process_single_question(question_data, current_user)
				results.append(result)
			db.session.commit()
			return jsonify(results), HTTP_201_CREATED
		else:  # If it's a single question
			result = process_single_question(data, current_user)
			db.session.commit()
			return result

	else:
		user = User.query.filter_by(id=current_user).first()
		if user:
			questions = user.questions

			returned_data = []

			if not questions:
				return jsonify({"error": "No data yet"}), HTTP_204_NO_CONTENT

			for question in questions:
				returned_data.append(
					{
						"id": question.id,
						"sentence": question.sentence,
						"language": question.language,
						"created_at": question.created_at,
						"topics": question.topic,
						"sub_topic": question.sub_topic,
						"category": question.category,
						"animal_crop": question.animal_crop,
						"location": question.location,
					}
				)

			return jsonify(returned_data), HTTP_200_OK
		else:
			return jsonify({"error": "User not found"}), HTTP_404_NOT_FOUND


@questions.route("/upload_question", methods=["POST"])
@jwt_required()
def upload_question():
	if "audio" not in request.files:
		return jsonify({"error": "No audio file provided"}), HTTP_400_BAD_REQUEST

	language = request.form.get("language")
	topic = request.form.get("topic", "")
	sub_topic = request.form.get("sub_topics", "")
	category = request.form.get("category", "")
	animal_crop = request.form.get("sub_category", "")
	location = request.form.get("location", "")

	audio = request.files["audio"]

	if audio:
		filename = os.path.join("static", "audio_uploads", audio.filename)
		if os.path.exists(filename):
			return jsonify({"Error": "File with same name already exists"})
		audio.save(filename)

	current_user = get_jwt_identity()
	question = Question(
		language=language,
		user_id=current_user,
		topic=topic,
		sub_topic=sub_topic,
		filename=filename,
		category=category,
		animal_crop=animal_crop,
		location=location,
	)

	db.session.add(question)
	db.session.flush()

	num_questions = Question.query.filter_by(user_id=current_user).count()
	today = datetime.date.today()
	questions = (
		Question.query.filter_by(user_id=current_user)
		.filter(func.date(Question.created_at) == today)
		.all()
	)
	todaysQuestions = []
	for question in questions:
		todaysQuestions.append(
			{
				"id": question.id,
				"sentence": question.sentence,
				"language": question.language,
				"created_at": question.created_at,
				"topics": question.topic,
				"sub_topic": question.sub_topic,
				"category": question.category,
				"animal_crop": question.animal_crop,
				"location": question.location,
				"filename": question.filename
			}
		)

	return {
		"num_questions": num_questions,
		"questions": todaysQuestions,
	}, HTTP_201_CREATED


@questions.route("/offline_upload", methods=["POST"])
@jwt_required()
def offline_upload():
	if "file" not in request.files:
		return jsonify({"error": "No metadata file provided"}), HTTP_400_BAD_REQUEST

	if "files" not in request.files:
		return jsonify({"error": "No audio files provided"}), HTTP_400_BAD_REQUEST

	metadata_file = request.files.get("file")
	audio_files = request.files.getlist("files")
	metadata = json.loads(metadata_file.read().decode("utf-8"))

	if not audio_files:
		return jsonify({"error": "No audio files provided"}), HTTP_400_BAD_REQUEST

	if not metadata:
		return jsonify({"error": "Metadata file not provided"}), HTTP_400_BAD_REQUEST

	current_user = get_jwt_identity()

	questions = []
	dup_count = 0
	duplicates = []

	for obj in metadata:
		audio_filename = obj['audio_filePath'].rsplit('.', 1)[0]
		
		for audio in audio_files:
			au  =  file_name(audio)[0]
			
			if audio_filename == au:
				
				filename = os.path.join("static", "audio_uploads", obj["audio_filename"])

				if os.path.exists(filename):
					dup_count += 1
					duplicates.append({"filename": filename})
					return (
						jsonify({"error": "File with the same name already exists"}),
						HTTP_400_BAD_REQUEST,
					)
				audio.save(filename) 		

				if obj:
					question_data = {
						"language": obj.get("language"),
						"topic": obj.get("topic", ""),
						"sub_topic": obj.get("sub_topics", ""),
						"category": obj.get("category", ""),
						"animal_crop": obj.get("sub_category", ""),
						"location": obj.get("location", ""),
						"user_id": current_user,
						"filename": filename,
					}

					question = Question(**question_data)
					questions.append(question)
				else:
					return (
						jsonify(
							{"error": f"No metadata found for audio file: {audio.filename}"}
						),
						HTTP_400_BAD_REQUEST,
					)

	db.session.add_all(questions)
	db.session.commit()

	num_questions = Question.query.filter_by(user_id=current_user).count()
	return (
		jsonify(
			{
				"num_questions": num_questions,
				"duplicate_questions": dup_count,
				"duplicates": duplicates,
			}
		),
		HTTP_200_OK,
	)


@questions.route("/file_upload/", methods=["POST"])
@jwt_required()
def upload_json_file():
	if request.method == "POST":
		file_json = request.files.get("file")
		json_data = json.load(file_json)

		current_user = get_jwt_identity()
		dup_count = 0
		duplicates = []

		for obj in json_data:
			sentence = obj["sentence"]
			language = obj["language"]
			topic = obj.get("topic")
			sub_topic = obj.get("sub_topics")
			category = obj.get("category")
			animal_crop = obj.get("sub_category")
			location = obj.get("location")

			if Question.query.filter_by(sentence=sentence).first():
				dup_count += 1
				duplicates.append({"sentence": sentence})
			else:
				question = Question(
					sentence=sentence,
					language=language,
					user_id=current_user,
					topic=topic,
					sub_topic=sub_topic,
					category=category,
					animal_crop=animal_crop,
					location=location,
				)
				db.session.add(question)
				db.session.commit()

		num_questions = Question.query.filter_by(user_id=current_user).count()

		return (
			jsonify(
				{
					"num_questions": num_questions,
					"duplicate_questions": dup_count,
					"duplicates": duplicates,
				}
			),
			HTTP_200_OK,
		)


@questions.get("/<int:id>")
@jwt_required()
def get_question(id):
	current_user = get_jwt_identity()

	question = Question.query.filter_by(user_id=current_user, id=id).first()

	if not question:
		return jsonify({"message": "Question not found"}), HTTP_404_NOT_FOUND

	return (
		jsonify(
			{
				"id": question.id,
				"language": question.language,
				"sentence": question.sentence,
				"created_at": question.created_at,
				"category": question.category,
				"animal_crop": question.animal_crop,
				"location": question.location,
			}
		),
		HTTP_200_OK,
	)

@jwt_required()
@questions.get('/delete-questions')
def delete_questions():
	try:
		questions_to_delete = Question.query.filter(Question.rephrased == "actual", Question.reviewed != True).all()
		
		# for question in questions_to_delete:
		#		Answer.query.filter_by(question_id=question.id).delete()

		# num_deleted = Question.query.filter(Question.rephrased == "actual", Question.reviewed != True).delete()
		num_deleted = len(questions_to_delete)

		db.session.commit()
		return jsonify({'message': f'{num_deleted} questions and associated answers deleted successfully'})
	except Exception as e:
		db.session.rollback()
		return jsonify({'error': 'An error occurred while deleting questions and answers'})


@jwt_required()
@questions.get("/displayall")
def display_questions():
	verify_jwt_in_request()
	curre = get_jwt_identity()
	isadmin = User.query.get(curre)
	page = request.args.get('page', 1, type=int)
	per_page = request.args.get('per_page', 100, type=int)
	questions = Question.query.filter(
		(Question.user_id != isadmin.id)
	).paginate(page=page, per_page=per_page, error_out=False)

	if not questions:
		return jsonify({"message": "No questions yet."}), HTTP_204_NO_CONTENT

	returned_data = []

	for question in questions:
		user = User.query.get(question.user_id)  # Get the user who asked the question
		if user:
			user_name = f"{user.firstname} {user.lastname}"

		returned_data.append(
			{
				"id": question.id,
				"sentence": question.sentence,
				"language": question.language,
				"created_at": question.created_at.strftime("%Y-%m-%d %H:%M:%S"),
				"topics": question.topic,
				"sub_topic": question.sub_topic,
				"category": question.category,
				"animal_crop": question.animal_crop,
				"location": question.location,
				"audio": question.filename,
				"user_name": user_name,
			}
		)

	return jsonify(returned_data), HTTP_200_OK


@jwt_required()
@questions.get("/all")
def get_questions():
	current_user = get_jwt_identity()
	isadmin = User.query.get(current_user)
	questions = Question.query.filter(
		(Question.user_id != isadmin.id)
	).all()

	if not questions:
		return jsonify({"message": "No questions yet."}), HTTP_204_NO_CONTENT

	returned_data = []

	for question in questions:
		user = User.query.get(question.user_id)
		if user:
			user_name = f"{user.firstname} {user.lastname}"

		returned_data.append(
			{
				"id": question.id,
				"sentence": question.sentence,
				"language": question.language,
				"created_at": question.created_at.strftime("%Y-%m-%d %H:%M:%S"),
				"topics": question.topic,
				"sub_topic": question.sub_topic,
				"category": question.category,
				"animal_crop": question.animal_crop,
				"location": question.location,
				"audio": question.filename,
				"user_name": user_name,
			}
		)

	return jsonify(returned_data), HTTP_200_OK



@jwt_required()
@questions.get("/download")
def download_questions():
	verify_jwt_in_request()
	user_id = get_jwt_identity()
	isadmin = User.query.get(user_id)
	start_date_str = request.args.get('start_date')
	
	if start_date_str:
		try:
			start_date = datetime.datetime.strptime(start_date_str, '%Y-%m-%d')
			questions = Question.query.filter(
				(Question.user_id != isadmin.id) &
				(Question.created_at >= start_date)
			).all()
		except ValueError:
			return jsonify({"message": "Invalid start_date format. Use YYYY-MM-DD."}), HTTP_400_BAD_REQUEST
	else:
		questions = Question.query.filter(
			(Question.rephrased != "actual")
		).all()

	if not questions:
		return jsonify({"message": "No questions yet."}), HTTP_204_NO_CONTENT

	returned_data = []

	for question in questions:
		user = User.query.get(question.user_id)  # Get the user who asked the question
		user_name = None
		if user:
			user_name = f"{user.firstname} {user.lastname}"

		returned_data.append(
			{
				"id": question.id,
				"sentence": question.sentence,
				"language": question.language,
				"created_at": question.created_at.strftime("%Y-%m-%d %H:%M:%S"),
				"topics": question.topic,
				"sub_topic": question.sub_topic,
				"category": question.category,
				"animal_crop": question.animal_crop,
				"location": question.location,
				"audio": question.filename,
				"user_name": user_name,
			}
		)
	return jsonify(returned_data), HTTP_200_OK

@jwt_required()
@questions.get("/myqns")
def get_my_questions():
	questions = Question.query.filter(
		(Question.rephrased == "actual")
	).all()

	if not questions:
		return jsonify({"message": "No questions yet."}), HTTP_204_NO_CONTENT

	returned_data = []

	for question in questions:
		user = User.query.get(question.user_id)
		if user:
			user_name = f"{user.firstname} {user.lastname}"

		returned_data.append(
			{
				"id": question.id,
				"sentence": question.sentence,
				"language": question.language,
				"created_at": question.created_at.strftime("%Y-%m-%d %H:%M:%S"),
				"topics": question.topic,
				"sub_topic": question.sub_topic,
				"category": question.category,
				"animal_crop": question.animal_crop,
				"location": question.location,
				"user_name": user_name,
				"reviewed":question.reviewed,
				"rephrased": question.rephrased
			}
		)

	return jsonify(returned_data), HTTP_200_OK

@jwt_required()
@questions.get("/top_users")
def top_users_with_most_questions():
	users_with_most_questions = (
		User.query.join(Question, User.id == Question.user_id)
		.group_by(User.id)
		.order_by(db.func.count(Question.id).desc())
		.all()
	)
	top_users_data = []
	for user in users_with_most_questions:
		top_users_data.append(
			{
				"user_id": user.id,
				"location": user.location,
				"firstname": user.firstname,
				"lastname": user.lastname,
				"username": user.username,
				"phone_number": user.phone_number,
				"total_questions": len(user.questions),
			}
		)

	return jsonify(top_users_data), HTTP_200_OK


@jwt_required()
@questions.get("/stats")
# @admin_required
def list_questions():
	verify_jwt_in_request()
	current_user = get_jwt_identity()
	isadmin = User.query.get(current_user)
	all_questions = Question.query.filter(
		(Question.user_id != isadmin.id)
	).all()
	
	#     all_questions = db.sessionQuestion).all()
	total_questions = len(all_questions)
	questions_per_language = (
		db.session.query(Question.language, func.count(Question.id))
		.filter((Question.user_id != isadmin.id))
		.group_by(Question.language)
		.all()
	)
	
	audio_questions = Question.query.filter(Question.filename.isnot(None)).all()

	average_daily_questions = total_questions / (
		Question.query.filter(
			(Question.rephrased != "actual"),
			(Question.user_id != isadmin.id)
			& (Question.created_at >= datetime.date.today())
		).count()
		or 1
	)

	one_week_ago = datetime.date.today() - datetime.timedelta(weeks=1)
	average_weekly_questions = total_questions / (
		Question.query.filter(
			(Question.rephrased != "actual"),
			(Question.user_id != isadmin.id)
			& (Question.created_at >= one_week_ago)
		).count()
		or 1
	)

	#  Calculate average questions per user
	total_users = User.query.count()
	average_questions_per_user = total_questions / (total_users or 1)
	
	plant_question_count = Question.query.filter(
		(Question.user_id != isadmin.id)
		& (func.lower(Question.category) == "crop")
	).count()

	animal_question_count = Question.query.filter(
		(Question.user_id != isadmin.id)
		& (func.lower(Question.category) == "animal")
	).count()

	response_data = {
		"total_questions": total_questions,
		"questions_per_language": [
			{"language": lang, "count": count} for lang, count in questions_per_language
		],
		"average_daily_questions": round(average_daily_questions, 2),
		"average_weekly_questions": round(average_weekly_questions, 2),
		"average_questions_per_user": round(average_questions_per_user, 2),
		"plant_category": plant_question_count,
		"animal_category": animal_question_count,
		"audios": len(audio_questions),
		"questions": [
			{
				"id": question.id,
				"topics": question.topic,
				"sub_topic": question.sub_topic,
				"sentence": question.sentence,
				"language": question.language,
				"created_at": question.created_at,
				"category": question.category,
				"animal_crop": question.animal_crop,
				"location": question.location,
			}
			for question in all_questions
		],
	}

	return jsonify(response_data), HTTP_200_OK


@questions.route("/random_question", methods=["GET"])
@jwt_required()
def random_question_and_add_answer():
	user_id = get_jwt_identity()
	random_question = (
		Question.query.filter(~Question.answers.any(Answer.source == "expert"))
		.order_by(db.func.random())
		.first()
	)

	if random_question:
		question_data = {
			"id": random_question.id,
			"sentence": random_question.sentence,
			"language": random_question.language,
			"created_at": random_question.created_at.strftime("%Y-%m-%d %H:%M:%S"),
			"topics": random_question.topic,
			"sub_topic": random_question.sub_topic,
			"category": random_question.category,
			"animal_crop": random_question.animal_crop,
			"location": random_question.location,
		}
		return jsonify(question_data), HTTP_200_OK
	else:
		return jsonify({"message": "No questions available."}), HTTP_404_NOT_FOUND


@questions.route("/main_question_review", methods=["POST"])
@jwt_required()
def main_question_review():

	sub_category_map = {
    "poultry": ["chicken", "ducks", "guinea fowls", "turkeys"],
    "vegetables":  [
			"tomatoes", "carrots", "onions", "mushrooms", "eggplant", "beetroot",
			"doodo", "spinach", "cucumbers", "avocado", "cabbage", "nakati", "ginger",
			"green pepper", "garlic", "okra", "lettuce", "malakwang", "pepper", "sukuma wiiki",
			"kale", "hubiscus", "crops", "crop"
		],
		"cattle": ["cattle", "goat", "goats", "sheep"],
		"fish": ["fish", 'Fish'],
		"banana": ["banana", "bananas", "crop", "crops"],
		"fruits": ["watermelon", "pineapple", "mango", "sugarcane", "orange", "avocado", "passion fruit", "jack fruit", "paw paw", "guava", "lemon"],
		"cereals": ["maize", "sorghum", "millet", "rice", "wheat", "sim sim", "sesame"],
		"legumes": [ "soya beans", "beans", "peas", "groundnuts", "Gnuts", "ground nuts"],
		"piggery": ["pigs", 'animal', 'animals']
  }

	data = request.get_json()
	
	category = data.get("category", None)
	language = data.get("language", None)
	sub_category = data.get("sub_category", None)
	new_category = data.get("new_category", None)

	filters = []

	expert_id = get_jwt_identity()

	category_filter = func.lower(Question.category) == category
	answers_count = Answer.query.filter_by(user_id=expert_id).count()
	sub_categories = [sc.strip().lower() for sc in new_category.split(",")]

	if len(sub_categories) >= 3 and answers_count >= 350:
		return jsonify({"message":"You have answered enough questions. START ranking."}), HTTP_200_OK
	elif len(sub_categories) < 3 and answers_count >= 250:
		return jsonify({"message":"You have answered enough questions. START ranking."}), HTTP_200_OK
	else:
		if language:
			languages = [lang.strip().lower() for lang in language.split(",")]
			language_filter = func.lower(Question.language).in_(languages)
			filters.append(language_filter)

		if sub_category:
			sub_category_filters = []
			
			for sub_category_name in sub_categories:
				sub_category_list = sub_category_map.get(sub_category_name)
				if sub_category_list:
					sub_category_filters.append( func.lower(Question.animal_crop).in_(sub_category_list))
				else:
					sub_category_filters.append(func.lower(Question.animal_crop) == sub_category_name)
			
			if sub_category_filters:
				filters.append(or_(*sub_category_filters))

	matching_questions = (
		Question.query.filter(Question.rephrased == "actual", Question.answered.is_(False), *filters)
		.all()
	)

	if matching_questions:
		random_question = random.sample(matching_questions, 1)[0]
		questions_data = format_question(random_question, "Any Language")
		return jsonify([questions_data]), HTTP_200_OK
	else:
		return jsonify({"message": "No questions available."}), HTTP_404_NOT_FOUND


@jwt_required()
@questions.route("/main_question_answer", methods=["POST"])
def main_question_answer():
	data = request.get_json()

	category = (data.get("category", None)).title()
	language = data.get("language", None)
	sub_category = data.get("sub_category", None)
	new_category = data.get("new_category", None)
	filters = []
	if language:
		if ',' in language:
			languages = [lang.strip().lower() for lang in language.split(",")]
			language_filter = func.lower(Question.language).in_(languages)
		else:
			language_filter = func.lower(Question.language) == language.strip().lower()
		filters.append(language_filter)
	
	if sub_category:
		sub_category = sub_category.lower()
		if sub_category.lower() == "vegetables":
			
	
			allowed_vegetables = [
				"tomatoes", "carrots", "onions", "mushrooms", "eggplant", 
        "beetroot", "doodoo", "spinach", "cucumbers", "avocado", 
        "cabbage", "nakati", "ginger", "green pepper", "garlic", 
        "okra", "lettuce", "malakwang", "pepper"
				]
			if ',' in sub_category:
				sub_categories = [lang.strip().lower() for lang in sub_category.split(",")]
				sub_category_filter = func.lower(Question.animal_crop).in_(sub_categories)
				sub_category_filter = and_(sub_category_filter, func.lower(Question.animal_crop).in_(allowed_vegetables))
			else:
				sub_category_filter = func.lower(Question.animal_crop).in_(allowed_vegetables)
		else:
			if ',' in sub_category:
				sub_categories = [lang.strip().lower() for lang in sub_category.split(",")]
				sub_category_filter = func.lower(Question.animal_crop).in_(sub_categories)
			else:
				sub_category_filter = func.lower(Question.animal_crop) == sub_category.strip().lower()
		filters.append(sub_category_filter)


	matching_questions = Question.query.filter(
		Question.category.ilike(category),
		Question.rephrased == "actual",
    Question.reviewed == True,
    Question.answered.is_not(True),
		*filters
		).order_by(db.func.random()).first()

	if matching_questions is not None:
		return jsonify(jsonify_question(matching_questions)), HTTP_200_OK
	else:
		return jsonify({"message": "No questions available."}), HTTP_404_NOT_FOUND


@questions.post("/add_answer/<int:question_id>")
@jwt_required()
def add_answer(question_id):
	data = request.get_json()
	user_id = get_jwt_identity()
	answer_text = request.json["answer"].strip()

	question = Question.query.get(question_id)
	if not question:
		return jsonify({"message": "Question not found."}), HTTP_404_NOT_FOUND

	if answer_text and len(answer_text) > 7:
		new_answer = Answer(
			question_id=question_id,
			user_id=user_id,
			answer_text=answer_text,
			source="expert",
		)

		db.session.add(new_answer)
		question.answered = True
		question.answer_expert_one = user_id
		db.session.commit()

		return jsonify({"message": "Answer added successfully."}), HTTP_201_CREATED
	return jsonify({"message": "Failed to add answer."})

@questions.post("/review_and_answer/<int:question_id>")
@jwt_required()
def review_and_answer(question_id):
	user_id = get_jwt_identity()
	question = Question.query.get(question_id)

	if not question:
		return jsonify({"message": "Question not found."}), HTTP_404_NOT_FOUND

	data = request.get_json()
	answer_text = data.get("answer", "").strip()
	new_topic = data.get("topic")

	if answer_text and len(answer_text) > 4:
		new_answer = Answer(
				question_id=question_id,
				user_id=user_id,
				answer_text=answer_text,
				source="expert",
		)

		db.session.add(new_answer)
		question.answered = True
		question.answer_expert_one = user_id

		if question.topic:
			if new_topic:
				question.topic = (new_topic + ", " + question.topic)
		else:
			question.topic = new_topic

		question.reviewed = True
		question.correct = True
		question.reviewer_id = user_id

		db.session.commit()

		return jsonify({"message": "Answer added successfully and question attributes updated."}), HTTP_201_CREATED

	return jsonify({"message": "Failed to add answer or update question attributes."})

@questions.route("/incorrect/<int:question_id>", methods=["PUT"])
@jwt_required()
def mark_question_as_reviewed(question_id):
	user_id = get_jwt_identity()
	question = Question.query.get(question_id)

	if question:
		question.reviewed = True
		question.correct = False
		question.reviewer_id = user_id

		db.session.commit()

		return jsonify({"message": "Question attributes updated"})
	else:
		return jsonify({"message": "Question not found"})


@questions.route("/question_review/<int:question_id>", methods=["PATCH"])
@jwt_required()
def question_review(question_id):
	user_id = get_jwt_identity()
	question = Question.query.get(question_id)
	
	if question:

		question.reviewed = True
		question.correct = True 
		question.reviewer_id = user_id

		rephrased_data = request.json.get(
			"rephrased"
		)
		if rephrased_data:
			question.sentence = rephrased_data

		new_topic = request.json.get(
			"topic"
		)
		if question.topic:
			if new_topic:
				question.topic = (
					new_topic + ", " + question.topic
				)
		else:
			question.topic = new_topic 

		db.session.commit()

		return jsonify({"message": "Question attributes updated"})
	else:
		return jsonify({"message": "Question not found"})


@questions.route("/random_unanswered_question", methods=["GET"])
@jwt_required()
def get_random_unanswered_question():
	user_id = get_jwt_identity()

	# Get a random unanswered question for the user
	random_questions = Question.query.filter(
		Question.rephrased == "actual",
    Question.reviewed == True,
    Question.answered.is_not(True),
		Question.user_id == user_id
	).all()
	print(len(random_questions))
	questions_data = []
	if random_questions:
		for random_question in random_questions:
			question_data = {
				"id": random_question.id,
				"sentence": random_question.sentence,
				"language": random_question.language,
				"category": random_question.category,
				"sub_topic": random_question.animal_crop,
				"location": random_question.location,
				# "sub_topic": random_question.sub_topic,
			}
			questions_data.append(question_data)
		return jsonify(questions_data), 200
	else:
		return jsonify({"message": "No unanswered questions available"}), 404


@questions.route("/luganda", methods=["GET"])
@jwt_required()
def get_luganda_questions():
	luganda_questions = Question.query.filter(
		(Question.rephrased != "actual"),
		(Question.cleaned.is_(None) | (Question.cleaned != "t"))
		& (func.lower(Question.language) == "luganda")
	).all()

	if luganda_questions:
		questions_data = []
		for question in luganda_questions:
			question_data = {
				"id": question.id,
				"sentence": question.sentence,
				"language": question.language,
				"created_at": question.created_at.strftime("%Y-%m-%d %H:%M:%S"),
				"topics": question.topic,
				"sub_topic": question.sub_topic,
				"category": question.category,
				"animal_crop": question.animal_crop,
				"location": question.location,
				"cleaned": question.cleaned,
			}
			questions_data.append(question_data)

		return jsonify(questions_data), HTTP_200_OK
	else:
		return jsonify({"message": "No Luganda questions found"}), HTTP_404_NOT_FOUND


@questions.route("/english", methods=["GET"])
@jwt_required()
def get_english_questions():
	english_questions = Question.query.filter(
		(Question.rephrased != "actual"),
		(Question.cleaned.is_(None) | (Question.cleaned != "t"))
		& (func.lower(Question.language) == "english")
	).all()

	if english_questions:
		questions_data = []
		for question in english_questions:
			question_data = {
				"id": question.id,
				"sentence": question.sentence,
				"language": question.language,
				"created_at": question.created_at.strftime("%Y-%m-%d %H:%M:%S"),
				"topics": question.topic,
				"sub_topic": question.sub_topic,
				"category": question.category,
				"animal_crop": question.animal_crop,
				"location": question.location,
				"cleaned": question.cleaned,
			}
			questions_data.append(question_data)

		return jsonify(questions_data), HTTP_200_OK
	else:
		return jsonify({"message": "No Luganda questions found"}), HTTP_404_NOT_FOUND
	
@questions.route("/runyankole", methods=["GET"])
@jwt_required()
def get_runyankole_questions():
	verify_jwt_in_request()
	current_user = get_jwt_identity()
	is_admin = User.query.get(current_user)

	runya_questions = (Question.query
	.filter(Question.user_id != is_admin.id)
	.filter(func.lower(Question.language) == "runyankole")
	.all())


	if runya_questions:
		questions_data = []
		for question in runya_questions:
			question_data = {
				"id": question.id,
				"sentence": question.sentence,
				"language": question.language,
				"created_at": question.created_at.strftime("%Y-%m-%d %H:%M:%S"),
				"topics": question.topic,
				"sub_topic": question.sub_topic,
				"category": question.category,
				"animal_crop": question.animal_crop,
				"location": question.location,
				"cleaned": question.cleaned,
			}
			questions_data.append(question_data)

		return jsonify(questions_data), HTTP_200_OK
	else:
		return jsonify({"message": "No Runyankole questions found"}), HTTP_404_NOT_FOUND
	
@questions.route("/audios", methods=["GET"])
@jwt_required()
def audio_questions():
	
	audio_questions_list = []

	# for filename in allaudios:
	# 	question_detail = Question.query.filter(func.lower(Question.filename) == filename.lower()).first()

	# 	if question_detail:
	# 		user = User.query.get(question_detail.user_id)
	# 		if user:
	# 			user_name = f"{user.firstname} {user.lastname}"
     
	# 		audio_questions_list.append({
	# 			'id': question_detail.id,
	# 			"language": question_detail.language,
	# 			"created_at": question_detail.created_at.strftime("%Y-%m-%d %H:%M:%S"),
	# 			"topics": question_detail.topic,
	# 			"sub_topic": question_detail.sub_topic,
	# 			"category": question_detail.category,
	# 			"animal_crop": question_detail.animal_crop,
	# 			"location": question_detail.location,
	# 			'filename': question_detail.filename,
	# 			'username': user_name,
	# 			# 'file_content': get_audio_file_content(file_path)
	# 		})
	# 		print(len(audio_questions_list))
	# if len(audio_questions_list) > 0:
	# 	return jsonify(audio_questions_list)
	# else:
	return jsonify({"message": "No Audio questions found"}), HTTP_404_NOT_FOUND

@questions.route("/expertluganda", methods=["GET"])
@jwt_required()
def get_expert_luganda_questions():
	luganda_questions = Question.query.filter(
		(Question.rephrased == "actual")
		& (func.lower(Question.language) == "luganda")
	).all()

	if luganda_questions:
		questions_data = []
		for question in luganda_questions:
			question_data = {
				"id": question.id,
				"sentence": question.sentence,
				"language": question.language,
				"created_at": question.created_at.strftime("%Y-%m-%d %H:%M:%S"),
				"topics": question.topic,
				"sub_topic": question.sub_topic,
				"category": question.category,
				"animal_crop": question.animal_crop,
				"location": question.location,
				"answered": question.answered,
				"ranking_count": question.ranking_count,
				"ranked": question.finished
			}
			questions_data.append(question_data)

		return jsonify(questions_data), HTTP_200_OK
	else:
		return jsonify({"message": "No Luganda expert questions found"}), HTTP_404_NOT_FOUND
	
@questions.route("/expertenglish", methods=["GET"])
@jwt_required()
def get_expert_english_questions():
	luganda_questions = Question.query.filter(
		(Question.rephrased == "actual")
		& (func.lower(Question.language) == "english")
	).all()

	if luganda_questions:
		questions_data = []
		for question in luganda_questions:
			question_data = {
				"id": question.id,
				"sentence": question.sentence,
				"language": question.language,
				"created_at": question.created_at.strftime("%Y-%m-%d %H:%M:%S"),
				"topics": question.topic,
				"sub_topic": question.sub_topic,
				"category": question.category,
				"animal_crop": question.animal_crop,
				"location": question.location,
				"answered": question.answered,
				"ranking_count": question.ranking_count,
				"ranked": question.finished
			}
			questions_data.append(question_data)

		return jsonify(questions_data), HTTP_200_OK
	else:
		return jsonify({"message": "No English expert questions found"}), HTTP_404_NOT_FOUND
	
@questions.route("/expertrunyankole", methods=["GET"])
@jwt_required()
def get_expert_runyankole_questions():
	luganda_questions = Question.query.filter(
		(Question.rephrased == "actual")
		& (func.lower(Question.language) == "runyankole")
	).all()

	if luganda_questions:
		questions_data = []
		for question in luganda_questions:
			question_data = {
				"id": question.id,
				"sentence": question.sentence,
				"language": question.language,
				"created_at": question.created_at.strftime("%Y-%m-%d %H:%M:%S"),
				"topics": question.topic,
				"sub_topic": question.sub_topic,
				"category": question.category,
				"animal_crop": question.animal_crop,
				"location": question.location,
				"answered": question.answered,
				"ranking_count": question.ranking_count,
				"ranked": question.finished
			}
			questions_data.append(question_data)

		return jsonify(questions_data), HTTP_200_OK
	else:
		return jsonify({"message": "No Runyankole expert questions found"}), HTTP_404_NOT_FOUND

@questions.route("/evaluated", methods=["GET"])
@jwt_required()
def get_evaluated_questions():
	
	matching_questions = (
		Question.query.filter(
			Question.ranking_count == 2)
		.all()
	)
	total_questions = len(matching_questions)
	print(total_questions)

	if matching_questions:
		questions_data = []
		for question in matching_questions:
			question_data = {
				"id": question.id,
				"sentence": question.sentence,
				"language": question.language,
				"created_at": question.created_at.strftime("%Y-%m-%d %H:%M:%S"),
				"topic": question.topic,
				"sub_topic": question.sub_topic,
				"category": question.category,
				"animal_crop": question.animal_crop,
				"location": question.location,
				"answers": []
			}

			for answer in question.answers:
				answer_data = {
					"id": answer.id,
					"answer_text": answer.answer_text,
					"source": answer.source,
					"relevance": answer.relevance,
					"coherence": answer.coherence,
					"fluency": answer.fluency,
					"context": answer.context,
					"created_at": answer.created_at.strftime("%Y-%m-%d %H:%M:%S"),
				}
				question_data["answers"].append(answer_data)

			questions_data.append(question_data)

		result_object = {
				"questions": questions_data,
				"total_questions": total_questions
		}
		print(len(question_data))
		return jsonify(result_object), HTTP_200_OK
	else:
		return jsonify({"message": "No questions available for ranking."}), HTTP_404_NOT_FOUND

@questions.route("/cleaning", methods=["GET"])
@jwt_required()
def clean_evaluated_questions():
	matching_questions = Question.query.filter(Question.ranking_count == 2).all()
	if matching_questions:
		for entry in matching_questions:
			for answer in entry.answers:
				if answer.relevance > 10:
					sum_of_digits = sum(int(digit) for digit in str(answer.relevance))
					answer.relevance = sum_of_digits
				if answer.coherence > 10:
					sum_of_digits = sum(int(digit) for digit in str(answer.coherence))
					answer.coherence = sum_of_digits
				if answer.fluency > 10:
					sum_of_digits = sum(int(digit) for digit in str(answer.fluency))
					answer.fluency = sum_of_digits
		db.session.commit()
		return jsonify({"message": "Values updated successfully."}), HTTP_200_OK
	else:
			return jsonify({"message": "No questions available for cleaning."}), HTTP_404_NOT_FOUND

@questions.route("/dataset_upload/", methods=["POST"])
@jwt_required()
def upload_excel_file():
	if request.method == "POST":
		file_excel = request.files.get("file")

		if file_excel and file_excel.filename.endswith(".xlsx"):
			try:
				# Read the Excel file using pandas
				df = pd.read_excel(file_excel)

				current_user = get_jwt_identity()
				dup_count = 0
				duplicates = []

				for _, row in df.iterrows():
					sentence = row.get("sentence")
					language = row.get("language")
					topic = row.get("topics", None)
					category = row.get("category", None)
					animal_crop = row.get("crop_animal", None)
					location = row.get("location", None)

					if Question.query.filter_by(sentence=sentence).first():
						dup_count += 1
						duplicates.append({"sentence": sentence})
					else:
						question = Question(
							sentence=sentence,
							language=language,
							user_id=current_user,
							topic=topic,
							category=category,
							animal_crop=animal_crop,
							location=location,
						)
						db.session.add(question)

				db.session.commit()

				num_questions = Question.query.filter_by(user_id=current_user).count()

				return (
					jsonify(
						{
							"num_questions": num_questions,
							"duplicate_questions": dup_count,
							"duplicates": duplicates,
						}
					),
					HTTP_200_OK,
				)
			except Exception as e:
				return jsonify({"message": str(e)}), HTTP_400_BAD_REQUEST
		else:
			return (
				jsonify(
					{"message": "Invalid file format. Please upload a .xlsx file."}
				),
				HTTP_400_BAD_REQUEST,
			)

@questions.route("/main_question_rank", methods=["POST"])
@jwt_required()
def main_question_rank():
	sub_category_map = {
    "poultry": ["chicken", "ducks", "guinea fowls", "turkeys"],
    "vegetables":  [
			"tomatoes", "carrots", "onions", "mushrooms", "eggplant", "beetroot",
			"doodo", "spinach", "cucumbers", "avocado", "cabbage", "nakati", "ginger",
			"green pepper", "garlic", "okra", "lettuce", "malakwang", "pepper", "sukuma wiiki",
			"kale", "hubiscus", "crops", "crop"
		],
		"cattle": ["cattle", "goat", "goats", "sheep"],
		"fish": ["fish", 'Fish'],
		"banana": ["banana", "bananas", "crop", "crops"],
		"fruits": ["watermelon", "pineapple", "mango", "sugarcane", "orange", "avocado", "passion fruit", "jack fruit", "paw paw", "guava", "lemon"],
		"cereals": ["maize", "sorghum", "millet", "rice", "wheat", "sim sim", "sesame"],
		"legumes": [ "soya beans", "beans", "peas", "groundnuts", "Gnuts", "ground nuts"],
		"piggery": ["pigs", 'animal', 'animals']
  }

	data = request.get_json()
	
	category = (data.get("category", None)).title()
	language = data.get("language", None)
	sub_category = data.get("sub_category", None)
	new_category = data.get("new_category", None)

	current_user = get_jwt_identity()

	filters = []
	
	random_question_data = None

	category_filter = func.lower(Question.category) == category
	languages = [lang.strip().lower() for lang in language.split(",")]
	# if language:
	# 	languages = [lang.strip().lower() for lang in language.split(",")]
	# 	language_filter = func.lower(Question.language).in_(languages)
	# 	filters.append(or_(*language_filter))

	sub_categories = [sc.strip().lower() for sc in new_category.split(",")]

	# sub_category_filters = []
	# if sub_category:
	# 	sub_category_filters = []
		
	# 	for sub_category_name in sub_categories:
	# 		sub_category_list = sub_category_map.get(sub_category_name)
	# 		if sub_category_list:
	# 			for item in sub_category_list:
	# 				is_matching_subcategory = func.lower(Question.animal_crop) == item.lower()
	# 				sub_category_filters.append(is_matching_subcategory)
	# 		else:
	# 			is_matching_subcategory = func.lower(Question.animal_crop) == item.lower()
	# 			sub_category_filters.append(is_matching_subcategory)
		
	# 	filters.append(and_(*sub_category_filters))
		

	random_questions = (
		Question.query.filter(
    	Question.answered.is_(True),
    	Question.finished.is_not(True))
			# (~Question.answers.any(Answer.user_id == current_user)),
			# Question.rank_expert_one != current_user)
			# Question.ranking_count < 2)
			# or_(*filters))
			# or_(*sub_category_filters))
		.all()
	)
	
	matching_questions = None
	print(len(random_questions))
	langua_filtered = []
	for item in random_questions:
		if any(lang == item.language.lower() for lang in languages):
			langua_filtered.append(item)

	print(len(langua_filtered))
	filtered_objects =[]

	for obj in langua_filtered:
		obj_subcategory = obj.animal_crop.lower()
		matched = False
		for subcat in sub_categories:
			if subcat in sub_category_map:
				if obj_subcategory in map(str.lower, sub_category_map[subcat]):
					matched = True
					break
			elif obj_subcategory == subcat:
				matched = True
				break
		if matched:
			filtered_objects.append(obj)
	
	print(len(filtered_objects))

	not_ranked_by_me = [obj for obj in filtered_objects if obj.rank_expert_one != current_user ]

	print(len(not_ranked_by_me))

	not_answered = [obj for obj in not_ranked_by_me if not any(cls.user_id == current_user for cls in obj.answers)]

	print(len(not_answered))

	
	# filtered_ranking = [item for item in items if item.mark is not None and item.mark < 2]
	if not_answered:
		partial_ranked_qns = [q for q in not_answered if q.ranking_count == 1]

		if partial_ranked_qns:
			matching_questions = random.choice(partial_ranked_qns)
		else:
			matching_questions = random.choice(not_answered)
	
	if matching_questions:
		random_question_data = {
			"id": matching_questions.id,
			"sentence": matching_questions.sentence,
			"language": matching_questions.language,
			"created_at": matching_questions.created_at.strftime("%Y-%m-%d %H:%M:%S"),
			"topic": matching_questions.topic,
			"sub_topic": matching_questions.sub_topic,
			"category": matching_questions.category,
			"animal_crop": matching_questions.animal_crop,
			"location": matching_questions.location,
			"filename": matching_questions.filename,
		}

	    # Create a list to store answer data for each associated answer
		answer_list = []
		for answer in matching_questions.answers:
			answer_data = {
				"id": answer.id,
				"answer_text": answer.answer_text,
				"source": answer.source,
				"relevance": answer.relevance,
				"coherence": answer.coherence,
				"fluency": answer.fluency,
				"rank": answer.rank,
				"created_at": answer.created_at.strftime("%Y-%m-%d %H:%M:%S"),
			}
			answer_list.append(answer_data)

		random_question_data["answers"] = answer_list

	if random_question_data:
		result_object = {"random_question_data": random_question_data}
		return jsonify(result_object), HTTP_200_OK
	else:
		return jsonify({"message": "No questions available for ranking."}), HTTP_404_NOT_FOUND
	
def upload_to_bucket(bucket_name, source_file_name, destination_blob_name):
    """Uploads a file to a GCP storage bucket."""
    storage_client = storage.Client()
    bucket = storage_client.bucket(bucket_name)
    blob = bucket.blob(destination_blob_name)
    blob.upload_from_filename(source_file_name)
    print(f"File {source_file_name} uploaded to {destination_blob_name} in bucket {bucket_name}.")

	
@questions.route("/fetch_questions", methods=["GET"])
@jwt_required()
def fetch_questions():
	page = request.args.get('page', 1, type=int)
	per_page = request.args.get('per_page', 50, type=int)

	matching_questions = (
		Question.query.filter(
			Question.rephrased == "actual",
    	Question.reviewed == False
			)
		.paginate(page=page, per_page=per_page, error_out=False)
	)
	all = []
	random_question_data = None
	if matching_questions:
		for question in matching_questions:
			answers = [{'text': answer.answer_text, 'source': answer.source} for answer in question.answers]

			random_question_data = {
				"id": question.id,
				"sentence": question.sentence,
				"language": question.language,
				"topic": question.topic,
				"sub_topic": question.sub_topic,
				"category": question.category,
				"animal_crop": question.animal_crop,
				"location": question.location,
				"answers": answers
			}
			all.append(random_question_data)

	if all:
		pagination_details = {
			'total_pages': matching_questions.pages,
			'current_page': matching_questions.page,
			'per_page': per_page,
			'total_questions': matching_questions.total
    }

		return jsonify({'questions': all, 'pagination': pagination_details}), HTTP_200_OK
	else:
		return jsonify({"message": "No questions available."}), HTTP_404_NOT_FOUND


@questions.route("/store_answer_ranks", methods=["POST"])
@jwt_required()
def store_answer_ranks():
	user_id = get_jwt_identity()
	data = request.json
	question_id = data.get("questionId")
	rankings = data.get("rankings")

	if question_id is None or rankings is None:
		return jsonify({"message": "Invalid data format"}), HTTP_400_BAD_REQUEST

	question = Question.query.get(question_id)

	if question is None:
		return jsonify({"error": "Question not found"}), HTTP_404_NOT_FOUND

	ranking_count = 0
	try:
		for ranking in rankings:
			answer_id = ranking.get("answer_id")
			answer = Answer.query.get(answer_id)

			if answer:
				relevance = answer.relevance if answer.relevance is not None else 0
				coherence = answer.coherence if answer.coherence is not None else 0
				fluency = answer.fluency if answer.fluency is not None else 0
				
				relevance = relevance + chanelle(ranking.get("relevance"))
				coherence = coherence + chanelle(ranking.get("coherence"))
				fluency = fluency + chanelle(ranking.get("fluency"))
				new_context = ranking.get("context")
				# answer.context = ranking.get("context")
				if ranking.get("isFlagged"):
					answer.offensive = True

				answer.relevance = relevance
				answer.coherence = coherence
				answer.fluency = fluency
				print(answer.context)
				print(new_context)
				if answer.context is None:
					answer.context = new_context
				elif answer.context.lower() == new_context.lower():
					pass
				else:
					answer.context = answer.context + new_context


		if question:
			if question.rank_expert_one is None:
				question.rank_expert_one = user_id
				question.ranking_count = 1
			else:
				question.rank_expert_two = user_id
				question.ranking_count = 2

			ranking_count += 1

		if ranking_count == 2 or question.ranking_count == 2:
			question.finished = True

		db.session.commit()
		return jsonify({"message": "Answer ranks stored successfully"}), HTTP_200_OK

	except Exception as e:
		db.session.rollback()
		return jsonify({"message": "Error storing answer ranks"}), HTTP_400_BAD_REQUEST


@questions.route("/expert-stats", methods=["GET"])
@jwt_required()
def question_stats():
	total_cleaned = Question.query.filter_by(cleaned=True, rephrased="actual").count()
	cleaned_and_reviewed = Question.query.filter_by(cleaned=True, reviewed=True, rephrased="actual").count()
	cleaned_reviewed_and_answered = Question.query.filter_by(
		cleaned=True, answered=True, rephrased="actual"
	).count()
	all_fields_true = Question.query.filter_by(cleaned=True, finished=True, rephrased="actual").count()
	experts = User.query.filter_by(role="expert").all()
	english_questions = Question.query.filter(
		Question.rephrased == "actual",
		Question.language.ilike("english")
	).count()
	luganda_questions = Question.query.filter(
		Question.rephrased == "actual",
		Question.language.ilike("luganda")
	).count()
	runyankole_questions = Question.query.filter(
		Question.rephrased == "actual",
		Question.language.ilike("runyankole")
	).count()

	fully_ranked = Question.query.filter(Question.ranking_count == 2).count()
	partial_ranked = Question.query.filter(Question.ranking_count == 1).count()

	expert_data = []
	for expert in experts:
		reviewed_questions_count = Question.query.filter_by(
			reviewer_id=expert.id
		).count()
		answers = Answer.query.filter_by(user_id=expert.id).count()

		ranked_answers = Question.query.filter((Question.rank_expert_one == expert.id) | (Question.rank_expert_two == expert.id)).count()

		expert_info = {
			"id": expert.id,
			"lastname": expert.lastname,
			"firstname": expert.firstname,
			"phone_number": expert.phone_number,
			"reviewed_questions_count": reviewed_questions_count,
			"answers_count": answers,
			"ranked_answers": ranked_answers,
			"language": expert.language,
			"expertise": expert.category,
			"sub_category": expert.sub_category,
			"new_category": expert.new_category,
			"created_at": expert.created_at,
		}

		expert_data.append(expert_info)

	return jsonify(
		{
			"total_cleaned": total_cleaned,
			"cleaned_and_reviewed": cleaned_and_reviewed,
			"cleaned_reviewed_and_answered": cleaned_reviewed_and_answered,
			"all_fields_true": all_fields_true,
			"experts": expert_data,
			"english_questions": english_questions,
			"luganda_questions": luganda_questions,
			"runyankole_questions": runyankole_questions,
			"fully_ranked": fully_ranked,
			"partial_ranked": partial_ranked
		}
	)


@questions.route("/user_answers", methods=["GET"])
@jwt_required()
def get_user_answers():
	user_id = get_jwt_identity()

	reviewed_questions_count = Question.query.filter_by(
		reviewer_id=user_id
	).count()

	questions_count = Question.query.filter(
		Question.answer_expert_one == user_id
	).count()

	answers = Answer.query.filter_by(user_id=user_id).count()

	ranked_answers = Question.query.filter((Question.rank_expert_one == user_id) | (Question.rank_expert_two == user_id)).count()

	user_answers = Answer.query.filter_by(user_id=user_id).all()
	answers_data = []

	for answer in user_answers:
		question = answer.question
		
		answers_data.append(
			{
				"id": answer.id,
				"answer_text": answer.answer_text,
				"created_at": answer.created_at,
				"question_id": answer.question_id,
				"sentence": question.sentence,
				"rank": question.ranking_count
			}
		)
	return jsonify({"questions_count":questions_count, "all_answers":answers_data, "answers": answers,"reviewed_questions": reviewed_questions_count,"ranked": ranked_answers})


@questions.route("/answers/<int:answer_id>", methods=["GET"])
@jwt_required()
def get_answer(answer_id):
	user_id = get_jwt_identity()


	answer = Answer.query.get(answer_id)
	if not answer:
		return jsonify({"error": "Answer not found"}), HTTP_404_NOT_FOUND

	if answer.user_id != user_id:
		return jsonify({"error": "Unauthorized access to answer details"}), 403

	question = Question.query.get(answer.question_id)
	if not question:
		return jsonify({"error": "Question not found"}), HTTP_404_NOT_FOUND

	response_data = {
		"answer_id": answer.id,
		"answer_text": answer.answer_text,
		"question_id": question.id,
		"question_text": question.sentence,
		"language": question.language,
		"animal_crop": question.animal_crop,
		"category": question.category,
		"topic": question.topic,
		"sub_topic": question.sub_topic,
	
	}

	return jsonify(response_data), HTTP_200_OK


@questions.route("/experts/<int:user_id>", methods=["GET"])
@jwt_required()
def get_expert_stats(user_id):
	answers = Answer.query.filter_by(user_id=user_id).all()
	if not answers:
		return jsonify({"error": "Answers not found"}), HTTP_404_NOT_FOUND

	answers_data = []
	for answer in answers:
		
		question = Question.query.get(answer.question_id)
		answers_data.append(
			{
				"answer_id": answer.id,
				"answer_text": answer.answer_text,
				"date": answer.created_at,
				"question_id": question.id,
				"question_text": question.sentence,
				"language": question.language,
				"animal_crop": question.animal_crop,
				"category": question.category,
				"topic": question.topic,
				"sub_topic": question.sub_topic,
			
			}
		)

	return jsonify(answers_data), HTTP_200_OK

@questions.route("/update_answer_text/<int:answer_id>", methods=["PUT"])
@jwt_required()
def update_answer_text(answer_id):
	answer = Answer.query.get(answer_id)
	if not answer:
		return jsonify({"message": "Answer not found"}), HTTP_404_NOT_FOUND
	new_answer_text = request.json.get("answer_text")

	if not new_answer_text:
		return jsonify({"message": "New answer_text not provided"}), HTTP_404_NOT_FOUND

	answer.answer_text = new_answer_text
	db.session.commit()

	return jsonify({"message": "Answer text updated successfully"}), HTTP_200_OK


@questions.route("/upload_json_answers/", methods=["GET"])
@jwt_required()
def upload_json_answers():

	current_user_id = get_jwt_identity()
	dup_count = 0
	duplicates = []

	for obj in embedded_json:
		sentence = obj.get("Questions")
		language = obj.get("language")
		topic = obj.get("Topics")
		sub_topic = obj.get("Sub topics")
		category = obj.get("Category")
		animal_crop = obj.get("Animal_crop")
		location = obj.get("Location")

		# Check if the question already exists
		existing_qn = Question.query.filter_by(sentence=sentence, cleaned=True, rephrased="actual").first()
		if existing_qn:
				dup_count += 1
				duplicates.append({"sentence": sentence})
				existing_qn.animal_crop = animal_crop
				existing_qn.sub_topic = sub_topic
				db.session.commit()

		else:
				question = Question(
						sentence=sentence,
						language=language,
						user_id=current_user_id,
						topic=topic,
						sub_topic=sub_topic,
						category=category,
						animal_crop=animal_crop,
						location=location,
						cleaned=True,
						rephrased="actual",
						reviewed=True,
						reviewer_id=1
				)
				db.session.add(question)
				db.session.commit()
				question_id = question.id

				response_categories = [
						"Llama2",
						"Bard",
						"Bing",
						"ChatGPT 3.5",
						"GPT 4",
				]
				for category in response_categories:
						response_value = obj.get(category)
						if response_value is not None:
								response = Answer(
										question_id=question_id,
										answer_text=response_value,
										source=category,
										user_id=current_user_id,
								)
								db.session.add(response)
								db.session.commit()

	response_data = {"duplicates_count": dup_count, "duplicates": duplicates}
	return jsonify(response_data), HTTP_200_OK


@questions.route("/issues", methods=["GET"])
@jwt_required()
def get_debug_answers():
	user_id = get_jwt_identity()
	updated_items = []
	list_of_lists = []
	oldpa =[]
	for item in oldpa:
		item_id = item['id']
		db_item = Answer.query.get(item_id)
		
		if db_item:
			list_of_lists.append([item, {
				'id': db_item.id,
				'coherence': db_item.coherence,
				'relevance': db_item.relevance,
				'fluency': db_item.fluency
			}])
			
	
	return jsonify({
		'updated_items': list_of_lists
	})


@questions.route("/expertsanswers", methods=["GET"])
@jwt_required()
def get_experts_and_answers():
	experts = User.query.filter_by(role='expert').all()
	experts_data = []
	
	for expert in experts:
		expert_data = {
			'id': expert.id,
			'username': expert.username,
			'expertise': expert.new_category,
			'answers': []
			}
		answers = Answer.query.filter_by(user_id=expert.id).all()
		
		for answer in answers:
			answer_data = {
				'id': answer.id,
				'question_id': answer.question_id,
				'answer_text': answer.answer_text,
				}
			expert_data['answers'].append(answer_data)
		experts_data.append(expert_data)

	return jsonify(experts_data)


@questions.route("/addexcelanswers", methods=["GET"])
@jwt_required()
def add_excel_answers():
	for expert, expert_data in list_of_expertiz.items():
		print(expert)
		user_id = expert_data['id']
		print(user_id)
		
		user = User.query.get(user_id)
		
		if user is None:
			return jsonify({'message': f'User with ID {user_id} not found'}), 404
		
		expert_answers = derek_list.get(expert, [])
		for answer_data in expert_answers:
			
			question_id = answer_data.get('Question_id')
			answer_text = answer_data.get('Answer')

			existing_question = Question.query.filter_by(id=question_id).first()
			
			if existing_question and not existing_question.answered:
				new_answer = Answer(
						question_id=question_id,
						user_id=user_id,
						answer_text=answer_text,
						source="expert"
				)
				db.session.add(new_answer)
				existing_question.answered = True
				existing_question.answer_expert_one = user_id
				existing_question.reviewed = True
				existing_question.correct = True
				existing_question.reviewer_id = user_id
	
			db.session.commit()
	
	return jsonify({'message': 'Answers updated successfully'}), 200
